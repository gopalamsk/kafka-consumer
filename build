
plugins {
    id 'io.spring.dependency-management' version '1.1.6'
    id 'org.springframework.boot' version '4.0.0'
    id "org.sonarqube" version "5.1.0.4882"
    id 'jacoco'
    id 'java'
id "com.diffplug.spotless" version "6.25.0"
}

group = 'fslpfm'
try {
    version = new File('/accp/version').text
} catch (FileNotFoundException ignored) {
    // Used for local builds and during PR builds
    version = '0.0.1-SNAPSHOT'
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

//ext['logback.version'] = '1.4.8'
//ext['lombok.version'] = '1.18.24'

dependencies {

	/**
	* Provides java sources built out of openapi and JSON schema for PFM
	**/




    implementation 'org.springframework.boot:spring-boot-starter'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-kafka'
    implementation 'org.springframework.boot:spring-boot-starter-aop:4.0.0-M1' //since it is milestone version need to specify version explicitly
    //IBM MQ and JMS

    implementation "com.ibm.mq:mq-jms-spring-boot-starter:3.2.1"
    implementation "com.ibm.mq:com.ibm.mq.allclient:9.4.3.0"
    implementation "org.springframework:spring-jms"


    // Swagger
	implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.5.0'
	implementation 'org.springdoc:springdoc-openapi-starter-webmvc-api:2.5.0'
    //Domain
    implementation 'fsl:fsl-schema-library:2.0.2'
    implementation 'fsl:fsl-aci-schema-library:0.1.3'
    implementation group: 'org.glassfish.jaxb', name: 'jaxb-runtime', version: '4.0.3'

    //ssl
    implementation 'fsl:common-util-ssl:0.1.3'
   // implementation 'fsl:fsl-common-util:1.0.1'

    // Kafka

    testImplementation("org.springframework.kafka:spring-kafka-test")
    implementation "io.confluent:kafka-json-serializer:7.9.0"
    implementation "io.confluent:kafka-json-schema-serializer:7.9.0"

	// Below Spring, Lombok and Mapstruct dependencies should be declared in specific order for annotationProcessor support
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
	compileOnly 'org.projectlombok:lombok'
	annotationProcessor 'org.projectlombok:lombok'
	
	annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'
    implementation 'org.mapstruct:mapstruct:1.6.0'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.6.0'

    testImplementation 'org.springframework.boot:spring-boot-starter-test'

}

spotless {
    java {
        // Apply only to real source code
        target 'src/main/java/**/*.java', 'src/test/java/**/*.java'

        // DO NOT touch generated code
        targetExclude 'build/**', 'src/**/generated/**'

        // Standard, accepted formatter
        googleJavaFormat('1.22.0')

        // What you actually want
        removeUnusedImports()
        trimTrailingWhitespace()
        endWithNewline()
    }
}


configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }

    all {
        resolutionStrategy.eachDependency { DependencyResolveDetails details ->
            // Override the dependencies in the Spring Boot BOM
            [
                    ['org.xerial.snappy', 'snappy-java', "1.1.10.4", 'Black Duck fix as of Feb 3rd, 2025']

            ].forEach { constraint ->
                if (constraint[1] != '') {
                    if (details.requested.group == constraint[0] && details.requested.name == constraint[1]) {
                        //println "Resolving version for " + details.requested.group + ":" + details.requested.name + " to " + constraint[2] + ". Reason: " + constraint[3]
                        details.useVersion constraint[2]
                        details.because constraint[3]
                    }
                } else {
                    if (details.requested.group == constraint[0]) {
                        //println "Resolving version for " + details.requested.group + " to " + constraint[2] + ". Reason: " + constraint[3]
                        details.useVersion constraint[2]
                        details.because constraint[3]
                    }
                }
            }
        }
    }
}
repositories {
    mavenCentral()

    maven {
        url "${artifactory_contextUrl}/jcenter"
        credentials {
            username = "${artifactory_user}"
            password = "${artifactory_password}"
        }
    }rd}"
        }
    }
    maven {
        url "${artifactory_contextUrl}/ext-release-gradle-plugins"
        credentials {
            username = "${artifactory_user}"
            password = "${artifactory_password}"
        }
    }
    maven {
        url "${artifactory_contextUrl}/ext-talend-cache"
        credentials {
            username = "${artifactory_user}"
            password = "${artifactory_password}"
        }
    }

        metadataSources {
            mavenPom()
            artifact()
            ignoreGradleMetadataRedirection()
        }
    }

}

bootJar {
    enabled = true
    duplicatesStrategy(DuplicatesStrategy.EXCLUDE)
    exclude('local-vault.properties', 'application-dev.yml', 'fraud-config-db-scripts')
}

jar {
    enabled = false
}

//Needed for adding lombok and mapstruct processing
sourceSets {
    acceptanceTest {
        resources {
            srcDirs 'src/acceptanceTest/resources'
        }
        java {
            srcDirs 'src/acceptanceTest/java'
        }
    }
    main {
        java {
            srcDirs "${project.buildDir}/generated/sources/annotationProcessor/java/main"
        }
    }
}

//Needed for mapstruct processing
compileJava.dependsOn clean
compileJava {
    options.compilerArgs += [
            '-Amapstruct.suppressGeneratorTimestamp=true',
            '-Amapstruct.suppressGeneratorVersionInfoComment=true',
            '-Amapstruct.verbose=true'
    ]
}


task acceptanceTest(type: Test) {
    group 'verification'

    classpath = sourceSets.acceptanceTest.runtimeClasspath
    classpath += sourceSets.acceptanceTest.resources
    testClassesDirs = sourceSets.acceptanceTest.output.classesDirs

    jacoco {
        enabled = false
    }

    systemProperty "spring.profiles.active", findProperty("spring.profiles.active")
    systemProperty "test.rootUrl", findProperty("test.rootUrl")
}

acceptanceTest.dependsOn compileAcceptanceTestJava

//should be in shared library
cleanAcceptanceTest {
    delete reportsDir
}


/************ JACOCO CONFIG ********************/
task jacocoAcceptanceTestReport {
}
test {
    useJUnitPlatform()
    finalizedBy jacocoTestReport

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.0
            }
        }
    }
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: coverageExclusions)
        }))
    }
}

jacocoTestReport {
    description 'Generates Code coverage report. Fails build if it does not meet minimum coverage.'
    reports {
        xml.required = true
        csv.required = false
        html.outputLocation = layout.buildDirectory.dir('jacocoHtml')
    }
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: coverageExclusions)
        }))
        check.dependsOn(jacocoTestCoverageVerification)
    }
}
//test.finalizedBy jacocoTestReport

afterEvaluate {
    sonarqube {
        properties {
            properties["sonar.jacoco.reportPath"] = "${buildDir}/jacoco/test.exec"
*'
            properties["sonar.coverage.exclusions"] = 'build/generated/sources/**/*'
        }
    }
}

