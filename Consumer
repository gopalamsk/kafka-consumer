package com.bank.phg.consumer;

import com.bns.fsl.domain.emt.FslIncomingPaymentEventsRequest;
import com.bank.phg.service.PayhubEventProcessor;
import com.bank.phg.utility.MessageConverter;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
@RequiredArgsConstructor
public class PayhubEventKafkaListener {

    private final PayhubEventProcessor payhubEventProcessor;
    private final MessageConverter messageConverter;

    @KafkaListener(topics = "${app.kafka.topics.incoming}", groupId = "${spring.kafka.consumer.group-id}")
    public void consumePayhubEventListener(ConsumerRecord<String, String> record) {
        // Note: Acknowledgement parameter removed to allow CommonErrorHandler 
        // to manage the offset commit after retries.

        final String payload = record.value();

        if (payload == null || payload.isBlank()) {
            log.warn("Skipping empty Kafka message. topic={}, partition={}, offset={}",
                    record.topic(), record.partition(), record.offset());
            return;
        }

        log.info("Payhub event processing started. topic={}, partition={}, offset={}",
                record.topic(), record.partition(), record.offset());

        // Conversion
        final var request = messageConverter.jsonToFslIncomingPaymentEventsRequestObject(payload);

        // Delegation to Processor (Orchestrator)
        // If an exception occurs here, the ErrorHandler will trigger 2 retries.
        payhubEventProcessor.processPayhubEvent(request, payload);

        log.info("Payhub event processed successfully. topic={}, partition={}, offset={}",
                record.topic(), record.partition(), record.offset());
    }
}
