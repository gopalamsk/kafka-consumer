package com.bank.phg.infrastructure.kafka;

import com.bank.phg.domain.exception.BusinessFatalException;
import com.bank.phg.domain.exception.MappingException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.listener.DefaultErrorHandler;
import org.springframework.kafka.support.ExponentialBackOffWithMaxRetries;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class PayhubErrorHandler extends DefaultErrorHandler {

    private static final long INITIAL_BACKOFF_MS = 5000L;

    public PayhubErrorHandler() {
        super(infiniteBackOff());

        // Stop the line for infra errors; do not move offset
        setCommitRecovered(false);

        // Drop bad data immediately
        addNotRetryableExceptions(
                MappingException.class,
                BusinessFatalException.class
        );

        setRetryListeners((record, ex, attempt) ->
                log.warn("RETRYING_MESSAGE. attempt={}, topic={}, offset={}",
                        attempt, record.topic(), record.offset())
        );
    }

    private static ExponentialBackOffWithMaxRetries infiniteBackOff() {
        var backOff = new ExponentialBackOffWithMaxRetries(ExponentialBackOffWithMaxRetries.UNLIMITED_ATTEMPTS);
        backOff.setInitialInterval(INITIAL_BACKOFF_MS);
        backOff.setMultiplier(2.0);
        backOff.setMaxInterval(60000L); 
        return backOff;
    }
}
